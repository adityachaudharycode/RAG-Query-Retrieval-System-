"""
Quick test script to verify your local Ollama setup
"""
import asyncio
import aiohttp
import requests
import json
import time


async def test_ollama_service():
    """Test if Ollama service is running"""
    print("üîç Testing Ollama Service")
    print("=" * 30)
    
    try:
        response = requests.get("http://localhost:11434/api/version", timeout=5)
        if response.status_code == 200:
            version_info = response.json()
            print(f"‚úÖ Ollama running: {version_info.get('version', 'Unknown')}")
            return True
        else:
            print(f"‚ùå Ollama responded with status: {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Ollama not accessible: {e}")
        print("üí° Make sure Ollama is running: ollama serve")
        return False


def test_available_models():
    """Test what models are available"""
    print("\nüìã Checking Available Models")
    print("=" * 30)
    
    try:
        response = requests.get("http://localhost:11434/api/tags", timeout=10)
        if response.status_code == 200:
            data = response.json()
            models = data.get("models", [])
            
            print(f"Found {len(models)} models:")
            for model in models:
                name = model.get("name", "Unknown")
                size = model.get("size", 0)
                size_gb = size / (1024**3) if size > 0 else 0
                print(f"   ‚Ä¢ {name} ({size_gb:.1f}GB)")
            
            # Check for required models
            model_names = [model["name"] for model in models]
            
            required_models = {
                "nomic-embed-text": "Embedding model",
                "llama3.2:3b": "Text generation (primary)",
                "llama3.2:1b": "Text generation (fallback)"
            }
            
            print(f"\nüéØ Required Models Check:")
            all_available = True
            for model, description in required_models.items():
                available = any(model in name for name in model_names)
                status = "‚úÖ" if available else "‚ùå"
                print(f"   {status} {model} - {description}")
                if not available:
                    all_available = False
                    print(f"      üí° Download with: ollama pull {model}")
            
            return all_available
            
    except Exception as e:
        print(f"‚ùå Error checking models: {e}")
        return False


async def test_embedding_model():
    """Test the embedding model"""
    print("\nüîç Testing Embedding Model")
    print("=" * 30)
    
    try:
        async with aiohttp.ClientSession() as session:
            start_time = time.time()
            
            async with session.post(
                "http://localhost:11434/api/embeddings",
                json={
                    "model": "nomic-embed-text",
                    "prompt": "What is the grace period for premium payment?"
                },
                timeout=30
            ) as response:
                
                if response.status == 200:
                    result = await response.json()
                    embedding = result.get("embedding", [])
                    
                    end_time = time.time()
                    
                    print(f"‚úÖ Embedding generated successfully!")
                    print(f"üìä Embedding dimensions: {len(embedding)}")
                    print(f"‚è±Ô∏è  Time taken: {end_time - start_time:.2f} seconds")
                    print(f"üî¢ Sample values: {embedding[:5]}")
                    return True
                else:
                    error_text = await response.text()
                    print(f"‚ùå Embedding failed: {error_text}")
                    return False
                    
    except Exception as e:
        print(f"‚ùå Embedding test failed: {e}")
        return False


async def test_text_generation():
    """Test text generation models"""
    print("\nüí¨ Testing Text Generation Models")
    print("=" * 30)
    
    models_to_test = ["llama3.2:3b", "llama3.2:1b"]
    
    for model in models_to_test:
        print(f"\nü§ñ Testing {model}...")
        
        try:
            async with aiohttp.ClientSession() as session:
                start_time = time.time()
                
                async with session.post(
                    "http://localhost:11434/api/generate",
                    json={
                        "model": model,
                        "prompt": "What is insurance? Answer in one sentence.",
                        "stream": False,
                        "options": {
                            "num_predict": 100,
                            "temperature": 0.1
                        }
                    },
                    timeout=60
                ) as response:
                    
                    if response.status == 200:
                        result = await response.json()
                        answer = result.get("response", "").strip()
                        
                        end_time = time.time()
                        
                        print(f"‚úÖ {model} working!")
                        print(f"üìù Answer: {answer}")
                        print(f"‚è±Ô∏è  Time: {end_time - start_time:.2f} seconds")
                    else:
                        error_text = await response.text()
                        print(f"‚ùå {model} failed: {error_text}")
                        
        except Exception as e:
            print(f"‚ùå {model} test failed: {e}")


async def test_full_pipeline():
    """Test the complete pipeline"""
    print("\nüîÑ Testing Complete Pipeline")
    print("=" * 30)
    
    # Test question and context
    question = "What is the grace period for premium payment?"
    context = """
    Insurance Policy Terms:
    The grace period for premium payment is 30 days from the due date.
    During this grace period, the policy remains in force.
    If the premium is not paid within the grace period, the policy will lapse.
    """
    
    try:
        async with aiohttp.ClientSession() as session:
            # Step 1: Generate embedding for question
            print("üîç Step 1: Generating question embedding...")
            start_time = time.time()
            
            async with session.post(
                "http://localhost:11434/api/embeddings",
                json={
                    "model": "nomic-embed-text",
                    "prompt": question
                },
                timeout=30
            ) as response:
                
                if response.status == 200:
                    embedding_result = await response.json()
                    embedding_time = time.time() - start_time
                    print(f"‚úÖ Embedding generated in {embedding_time:.2f}s")
                else:
                    print("‚ùå Embedding failed")
                    return False
            
            # Step 2: Generate answer using context
            print("üí¨ Step 2: Generating answer...")
            start_time = time.time()
            
            full_prompt = f"""Context: {context.strip()}

Question: {question}

Please provide a clear answer based on the context.

Answer:"""
            
            async with session.post(
                "http://localhost:11434/api/generate",
                json={
                    "model": "llama3.2:3b",
                    "prompt": full_prompt,
                    "stream": False,
                    "options": {
                        "num_predict": 200,
                        "temperature": 0.1
                    }
                },
                timeout=60
            ) as response:
                
                if response.status == 200:
                    result = await response.json()
                    answer = result.get("response", "").strip()
                    generation_time = time.time() - start_time
                    
                    print(f"‚úÖ Answer generated in {generation_time:.2f}s")
                    print(f"üìù Answer: {answer}")
                    
                    total_time = embedding_time + generation_time
                    print(f"‚è±Ô∏è  Total pipeline time: {total_time:.2f}s")
                    return True
                else:
                    print("‚ùå Text generation failed")
                    return False
                    
    except Exception as e:
        print(f"‚ùå Pipeline test failed: {e}")
        return False


async def main():
    """Main test function"""
    print("üß™ LOCAL OLLAMA SETUP TEST")
    print("=" * 50)
    print("Testing your existing setup:")
    print("‚Ä¢ Ollama service")
    print("‚Ä¢ llama3.2:3b & llama3.2:1b")
    print("‚Ä¢ nomic-embed-text")
    print("=" * 50)
    
    # Test 1: Ollama service
    if not test_ollama_service():
        print("\n‚ùå Ollama service not running. Please start it with: ollama serve")
        return
    
    # Test 2: Available models
    if not test_available_models():
        print("\n‚ùå Some required models are missing. Please download them.")
        return
    
    # Test 3: Embedding model
    if not await test_embedding_model():
        print("\n‚ùå Embedding model not working properly.")
        return
    
    # Test 4: Text generation models
    await test_text_generation()
    
    # Test 5: Full pipeline
    pipeline_success = await test_full_pipeline()
    
    print("\n" + "=" * 50)
    print("üìä TEST SUMMARY")
    print("=" * 50)
    
    if pipeline_success:
        print("üéâ ALL TESTS PASSED!")
        print("‚úÖ Your local setup is working perfectly")
        print("üöÄ Ready to run: python run_local_only.py")
        print("\nüí° Benefits of your local setup:")
        print("   ‚Ä¢ $0.00 cost per request")
        print("   ‚Ä¢ No rate limits")
        print("   ‚Ä¢ Complete privacy")
        print("   ‚Ä¢ Works offline")
        print("   ‚Ä¢ Consistent performance")
    else:
        print("‚ö†Ô∏è  Some tests failed")
        print("üí° Check the errors above and fix them")
        print("üîß Common fixes:")
        print("   ‚Ä¢ Make sure Ollama is running: ollama serve")
        print("   ‚Ä¢ Download missing models: ollama pull <model-name>")
        print("   ‚Ä¢ Restart Ollama service if needed")


if __name__ == "__main__":
    asyncio.run(main())
